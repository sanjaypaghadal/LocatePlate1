USE [LocatePlate]
GO
/****** Object:  StoredProcedure [dbo].[RestaurantDetails]    Script Date: 2/14/2021 1:34:03 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[RestaurantDetails]
	 (@url varchar(200),@cityname varchar(200))
AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
			SELECT
		    Id= NEWID(),
			MenuItem= m.Name,
			m.Price,
			m.Calories,
			m.FoodNatureName,
			m.Images,
			m.MenuCategoryName,
			m.About as MenuAbout,
			m.UserId,
		    MenuId=	m.Id,
			r.Name as RestaurantName,
			r.CostForTwo,
			r.FullAddress,
			r.Cuisine,
			r.About,
			r.Id as RestaurantId,
			r.CoverImages,
		    RatingCount= AVG(ra.Rating),
			ReviewCount = sum(case when re.Review != null and re.Review != '' then 1 else 0 end)
            FROM
             dbo.Menus as m
			    LEFT OUTER JOIN dbo.Restaurants as r on  m.RestaurantId=r.Id
			    LEFT OUTER JOIN [dbo].Ratings AS ra ON ra.RestaurantId = r.Id 
			    LEFT OUTER JOIN [dbo].Reviews AS re ON re.RestaurantId = r.Id 
		   where r.Url=@url and r.CityName=@cityname
		    GROUP BY
         m.Name,
			m.Price,
			m.Calories,
			m.FoodNatureName,
			m.Images,
			m.MenuCategoryName,
			m.About,
			m.UserId,
			m.CreatedBy,
			m.UserId,
			r.Name,
			r.CostForTwo,
			r.FullAddress,
			r.Cuisine,
			r.About,
			r.Id,
			r.CoverImages,
			m.Id,
			m.CreatedDate
			order by MenuCategoryName,m.CreatedDate
   END
